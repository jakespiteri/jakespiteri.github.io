<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Jake Spiteri">
<meta name="description" content="Tidyverse The Tidyverse is a set of inter-compatible packages that are used throughout data science. The Tidyverse provides powerful tools that allow us to quickly `tidy’ data into data frames, transform the data, and then visualize it. This will then allow us to produce models. Throughout this report we will explore a real dataset found on Kaggle.
Pipes The pipe operator %&amp;gt;% is provided by the magrittr R package. Pipes are a powerful tool that allow us to clearly express a sequence of operations." />
<meta name="keywords" content="statistics, mathematics, data science, machine learning, deep learning" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="#252627" />
<link rel="canonical" href="https://jakespiteri.co.uk/portfolio/computing/report-6/" />


    <title>
        
            Portfolio Report 6: Tidyverse :: Jake Spiteri  — Jake Spiteri
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="https://jakespiteri.co.uk/main.min.7bfbbe12786fa0ded4b4c0d792cbb36a5bd0bdb0b856dde57aa7b1f6fe0f2b87.css">


    
        <link rel="stylesheet" type="text/css" href="static/style.css">
    



    <link rel="apple-touch-icon" sizes="180x180" href="https://jakespiteri.co.uk/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://jakespiteri.co.uk/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://jakespiteri.co.uk/favicon-16x16.png">
    <link rel="manifest" href="https://jakespiteri.co.uk/site.webmanifest">
    <link rel="mask-icon" href="https://jakespiteri.co.uk/safari-pinned-tab.svg" color="#252627">
    <link rel="shortcut icon" href="https://jakespiteri.co.uk/favicon.ico">
    <meta name="msapplication-TileColor" content="#252627">
    <meta name="theme-color" content="#252627">

<meta itemprop="name" content="Portfolio Report 6: Tidyverse">
<meta itemprop="description" content="Tidyverse The Tidyverse is a set of inter-compatible packages that are used throughout data science. The Tidyverse provides powerful tools that allow us to quickly `tidy’ data into data frames, transform the data, and then visualize it. This will then allow us to produce models. Throughout this report we will explore a real dataset found on Kaggle.
Pipes The pipe operator %&gt;% is provided by the magrittr R package. Pipes are a powerful tool that allow us to clearly express a sequence of operations.">

<meta itemprop="wordCount" content="2483">
<meta itemprop="image" content="https://jakespiteri.co.uk"/>



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://jakespiteri.co.uk"/>

<meta name="twitter:title" content="Portfolio Report 6: Tidyverse"/>
<meta name="twitter:description" content="Tidyverse The Tidyverse is a set of inter-compatible packages that are used throughout data science. The Tidyverse provides powerful tools that allow us to quickly `tidy’ data into data frames, transform the data, and then visualize it. This will then allow us to produce models. Throughout this report we will explore a real dataset found on Kaggle.
Pipes The pipe operator %&gt;% is provided by the magrittr R package. Pipes are a powerful tool that allow us to clearly express a sequence of operations."/>















<link href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/dracula.min.css' rel='stylesheet' type='text/css' />



    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://jakespiteri.co.uk/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">$ cd /home/</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://jakespiteri.co.uk/about/">About</a></li><li><a href="https://jakespiteri.co.uk/portfolio/">Portfolio</a></li><li><a href="https://jakespiteri.co.uk/posts/">Posts</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="https://jakespiteri.co.uk/portfolio/computing/report-6/">Portfolio Report 6: Tidyverse</a></h2>

            

            <div class="post-content">
                


<div id="tidyverse" class="section level1">
<h1>Tidyverse</h1>
<p>The Tidyverse is a set of inter-compatible packages that are used throughout data science. The Tidyverse provides powerful tools that allow us to quickly `tidy’ data into data frames, transform the data, and then visualize it. This will then allow us to produce models. Throughout this report we will explore a real dataset found on Kaggle.</p>
<div id="pipes" class="section level2">
<h2>Pipes</h2>
<p>The pipe operator <code>%&gt;%</code> is provided by the <code>magrittr</code> R package. Pipes are a powerful tool that allow us to clearly express a sequence of operations. It may be intuitive to read the operator <code>%&gt;%</code> as ‘piped into’. Thus we would read <code>a_R_object %&gt;% a_function</code> as ‘a R object is piped into a function’. The general idea is that <code>g(f(x))</code> can be rewritten as <code>x %&gt;% f %&gt;% g</code>. This is particularly useful when we are transforming data and want to sequentially make changes. Below we write two versions of the same code, one which uses pipes and one which uses traditional R programming.</p>
<p>First we import the tidyverse.</p>
<pre class="r"><code>library(tidyverse)</code></pre>
<pre class="r"><code># setup
par(mfrow=c(1,2))
x &lt;- seq(0,10, length.out=1000)

# normal R programming
plot(sqrt(abs(cos(x))))

# with the piping operator
x %&gt;% cos %&gt;% abs %&gt;% sqrt %&gt;% plot</code></pre>
<p><img src="https://jakespiteri.co.uk/portfolio/computing/Report-6_files/figure-html/unnamed-chunk-2-1.png" width="1344" style="display: block; margin: auto;" />
Note that in this case the piping operator is <em>less</em> clear. Note the y label in the above graph. It is <code>.</code> because the piping operator’s partial results are stored in <code>.</code>. We can also use the <code>.</code> to tell the piping operator where to pipe your variable into. For example, we may have a function with two inputs.</p>
<pre class="r"><code># function with two inputs
cust_add &lt;- function(x1,x2) {
  return(x1+2*(x2))
}

# define a sequence
x &lt;- seq(0,1,length.out = 10)

# pipe x into the second element of cust_add()
x %&gt;% cust_add(1, .)</code></pre>
<pre><code>##  [1] 1.000000 1.222222 1.444444 1.666667 1.888889 2.111111 2.333333 2.555556
##  [9] 2.777778 3.000000</code></pre>
<pre class="r"><code># sanity check
cust_add(1,x) == x %&gt;% cust_add(1, .)</code></pre>
<pre><code>##  [1] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE</code></pre>
<p>It is worth noting that by default, the piping operator pipes into the first input of a function, so <code>x %&gt;% function(y)</code> becomes <code>function(x,y)</code>.</p>
<p>We now look at an example with the dataset UKload. An example with data is perhaps the best way to demonstrate the power of pipes.</p>
<pre class="r"><code>data(UKload)
head(UKload)</code></pre>
<pre><code>##     NetDemand       wM   wM_s95       Posan      Dow      Trend NetDemand.48
## 25      38353 6.046364 5.558800 0.001369941   samedi 1293879600        38353
## 73      41192 2.803969 3.230582 0.004109824 dimanche 1293966000        38353
## 121     43442 2.097259 1.858198 0.006849706    lundi 1294052400        41192
## 169     50736 3.444187 2.310408 0.009589588    mardi 1294138800        43442
## 217     50438 5.958674 4.724961 0.012329471 mercredi 1294225200        50736
## 265     50064 4.124248 4.589470 0.015069353    jeudi 1294311600        50438
##     Holy Year                Date
## 25     1 2011 2011-01-01 12:00:00
## 73     0 2011 2011-01-02 12:00:00
## 121    0 2011 2011-01-03 12:00:00
## 169    0 2011 2011-01-04 12:00:00
## 217    0 2011 2011-01-05 12:00:00
## 265    0 2011 2011-01-06 12:00:00</code></pre>
<p>Pipes make transforming the data via a sequence of operations simple, and easy to read.</p>
<pre class="r"><code># setup plot
par(mfrow=c(1,2))

# look at transformed data for lundi
UKload %&gt;%
  subset(Dow == &quot;lundi&quot;, select = c(&quot;NetDemand&quot;, &quot;Posan&quot;)) %&gt;%
  head(100) %&gt;%
  transform(Posan = Posan * 365) %&gt;%
  glimpse</code></pre>
<pre><code>## Observations: 100
## Variables: 2
## $ NetDemand &lt;dbl&gt; 43442, 50645, 48105, 49792, 51282, 47985, 46741, 50163, 484…
## $ Posan     &lt;dbl&gt; 2.500143, 9.500542, 16.500942, 23.501341, 30.501741, 37.502…</code></pre>
<pre class="r"><code># lundi
UKload %&gt;%
  subset(Dow == &quot;lundi&quot;, select = c(&quot;NetDemand&quot;, &quot;Posan&quot;)) %&gt;%
  head(100) %&gt;%
  transform(Posan = Posan * 365) %&gt;%
  plot(NetDemand ~ Posan, data = ., ylim=c(33000,53000),
       main = &quot;Net energy demand on Mondays&quot;, xlab = &quot;Day in year&quot;, ylab = &quot;Net demand&quot;)

# samedi
UKload %&gt;%
  subset(Dow == &quot;samedi&quot;, select = c(&quot;NetDemand&quot;, &quot;Posan&quot;)) %&gt;%
  head(100) %&gt;%
  transform(Posan = Posan * 365) %&gt;%
  plot(NetDemand ~ Posan, data = ., ylim=c(33000,53000),
       main = &quot;Net energy demand on Saturdays&quot;, xlab = &quot;Day in year&quot;, ylab = &quot;Net demand&quot;)</code></pre>
<p><img src="https://jakespiteri.co.uk/portfolio/computing/Report-6_files/figure-html/unnamed-chunk-5-1.png" width="1344" style="display: block; margin: auto;" /></p>
</div>
<div id="advanced-piping" class="section level2">
<h2>Advanced piping</h2>
<p>There are other types of operators with specific properties. Note that you may need to import the library <code>magrittr</code> after importing the Tidyverse in order to use advanced pipes.</p>
<div id="the-assignment-pipe" class="section level3">
<h3>The assignment pipe <code>%&lt;&gt;%</code></h3>
<p>The operator <code>%&lt;&gt;%</code> works the same as the classic pipe <code>%&gt;%</code>, but it also assigns the transformation to the original object. We can see this below.</p>
<pre class="r"><code>x &lt;- seq(0,1,length.out=5)
print(x)</code></pre>
<pre><code>## [1] 0.00 0.25 0.50 0.75 1.00</code></pre>
<pre class="r"><code>x %&lt;&gt;% rev
print(x)</code></pre>
<pre><code>## [1] 1.00 0.75 0.50 0.25 0.00</code></pre>
</div>
<div id="the-tee-pipe-t" class="section level3">
<h3>The <code>tee</code> pipe <code>%T&gt;%</code></h3>
<p>We may want to store the output of our sequence of operations. We can often do this via the assignment operator, but we often pipe our output into the <code>plot</code> function. In this case, we cannot use the assignment operator as seen below.</p>
<pre class="r"><code>s &lt;- seq(0,10,length.out=100)
s %&lt;&gt;%
  cos %&gt;% plot</code></pre>
<p><img src="https://jakespiteri.co.uk/portfolio/computing/Report-6_files/figure-html/unnamed-chunk-7-1.png" width="384" style="display: block; margin: auto;" /></p>
<pre class="r"><code>print(s)</code></pre>
<pre><code>## NULL</code></pre>
<p>We see that <span class="math inline">\(s\)</span> is <code>NULL</code>. Instead we may store the output in the middle of a sequence of pipes by using the <code>tee</code> operator <code>%T&gt;%</code> as seen below. We begin the pipe with the assignment operator <code>&lt;-</code>. Note that <span class="math inline">\(s\)</span> now stores the output of the <span class="math inline">\(cos()\)</span> function.</p>
<pre class="r"><code>par(mfrow=c(1,2))
s &lt;- seq(0,10,length.out=100)
s &lt;- s %&gt;%
  cos %T&gt;% plot
plot(s)</code></pre>
<p><img src="https://jakespiteri.co.uk/portfolio/computing/Report-6_files/figure-html/unnamed-chunk-8-1.png" width="1344" style="display: block; margin: auto;" /></p>
<pre class="r"><code>print(s[1:5])</code></pre>
<pre><code>## [1] 1.0000000 0.9949028 0.9796632 0.9544366 0.9194801</code></pre>
</div>
<div id="the-exposition-pipe" class="section level3">
<h3>The <code>exposition</code> pipe <code>%$%</code></h3>
<p>When using pipes, we may encounter a scenario in which we want the names on the left hand side of the pipe to be easily available to the right hand side. This is what the exposition pipe does. This is particularly useful when working with named data and lists. Below we work with the UKload dataset for an example.</p>
<pre class="r"><code>head(UKload)</code></pre>
<pre><code>##     NetDemand       wM   wM_s95       Posan      Dow      Trend NetDemand.48
## 25      38353 6.046364 5.558800 0.001369941   samedi 1293879600        38353
## 73      41192 2.803969 3.230582 0.004109824 dimanche 1293966000        38353
## 121     43442 2.097259 1.858198 0.006849706    lundi 1294052400        41192
## 169     50736 3.444187 2.310408 0.009589588    mardi 1294138800        43442
## 217     50438 5.958674 4.724961 0.012329471 mercredi 1294225200        50736
## 265     50064 4.124248 4.589470 0.015069353    jeudi 1294311600        50438
##     Holy Year                Date
## 25     1 2011 2011-01-01 12:00:00
## 73     0 2011 2011-01-02 12:00:00
## 121    0 2011 2011-01-03 12:00:00
## 169    0 2011 2011-01-04 12:00:00
## 217    0 2011 2011-01-05 12:00:00
## 265    0 2011 2011-01-06 12:00:00</code></pre>
<pre class="r"><code>UKload %&gt;%
  subset(Year == 2011) %$%
  cor(wM, NetDemand)</code></pre>
<pre><code>## [1] -0.6858647</code></pre>
<p>Without the exposition pipe this would be done in the following way.</p>
<pre class="r"><code>UKload %&gt;%
  subset(Year == 2011) %&gt;%
  {cor(.$wM, .$NetDemand)}</code></pre>
<pre><code>## [1] -0.6858647</code></pre>
</div>
</div>
<div id="visualizations-with-ggplot2" class="section level2">
<h2>Visualizations with ggplot2</h2>
<p>We will use ggplot2 for an exploratory analysis of the ASHRAE - Great Energy Predictor III dataset found <a href="https://www.kaggle.com/c/ashrae-energy-prediction">here</a> on Kaggle.</p>
<div id="data-setup" class="section level3">
<h3>Data setup</h3>
<pre class="r"><code># set the seed for reproducibility
set.seed(1)

# load the whole dataset
data_train &lt;- read.csv(&quot;~/Downloads/energy_data/train.csv&quot;)

# inspect
head(data_train); dim(data_train)

# we load the other files and join them into one data frame
building_data &lt;- read.csv(&quot;~/Downloads/energy_data/building_metadata.csv&quot;)
weather_train &lt;- read.csv(&quot;~/Downloads/energy_data/weather_train.csv&quot;)

# join the data together
all_train &lt;- data_train %&gt;%
  left_join(building_data, by = &quot;building_id&quot;) %&gt;%
  left_join(weather_train, by = c(&quot;site_id&quot;, &quot;timestamp&quot;))

# check memory size
all_train %&gt;% object.size %&gt;% format(units = &quot;MB&quot;)

# we see that although building_metadata.csv, and weather_train.csv are very small files
# the combined data frame has size approx 1850Mb
# so we only keep a subset to work with
# keep only a subset of the dataset
nlevels(as.factor(all_train$building_id))
data_subset &lt;- all_train %&gt;% 
  filter(building_id %in% sample(1449, 150))
head(data_subset)

# let&#39;s save this data so we don&#39;t have to import the full dataset again
write.csv(data_subset, &quot;~/Downloads/energy_data/subset_combined_train.csv&quot;)</code></pre>
<p>The above code combined the multiple files, and saves a subset of the combined training data. The full dataset (1449 <code>building_id</code>s) has approximate size 1850Mb whereas the subset of 150 <code>building_id</code>s only uses 1.4b of memory. To avoid the unnecessary memory usage in the above step, the code has been ran once and the subset had been written to a .csv file.</p>
</div>
<div id="intro-to-ggplot2" class="section level3">
<h3>Intro to <code>ggplot2</code></h3>
<p>Let’s import the dataset <code>data_subset</code> and add some useful variables such as the day, hour, etc.</p>
<pre class="r"><code># import the dataset
data_subset &lt;- read.csv(&quot;data/subset_combined_train.csv&quot;)

# create new feature variables based on the date/time
data_subset &lt;- data_subset %&gt;%
  mutate(timestamp_ymd_hms = ymd_hms(timestamp),
         timestamp_hour = factor(hour(timestamp_ymd_hms)),
         timestamp_day = factor(day(timestamp_ymd_hms)),
         timestamp_week = factor(week(timestamp_ymd_hms)),
         timestamp_month = factor(month(timestamp_ymd_hms, label=TRUE)),
         timestamp_year = factor(year(timestamp_ymd_hms)),
         meter = factor(meter)
         )

# for basic plots
small_data_subset &lt;- data_subset %&gt;%
  subset(timestamp_month %in% c(&quot;Jun&quot;, &quot;Nov&quot;)) %&gt;%
  group_by(timestamp_hour, timestamp_month) %&gt;%
  summarise(avg_meter_reading = median(meter_reading))</code></pre>
<p>In the above example we see that functions provided by the tidyverse make code much neater and easier to write. Feature engineering becomes simpler with functions such as <code>group_by()</code>. We now start from the basics and build plots with <code>ggplot2</code>.</p>
<p>Base R plots are called for their side effects rather than the returned value. When calling <code>plot</code> we indeed produce a plot, but the function doesn’t return anything of value. This is quite different to <code>ggplot2</code> in which we create and store a <code>ggplot</code> object, which we then call to produce a plot.</p>
<p>When using <code>ggplot</code> we add multiple layers to the plot. We initially create the plot object, which creates a blank canvas. We may then add a scatterplot or histogram layer. If we then wanted to add a title or legend, we would add these to our <code>ggplot</code> object.</p>
<p>Calling <code>ggplot</code> defines a blank canvas. We can then add a scatter plot to the canvas.</p>
<pre class="r"><code># first plot
plot1 &lt;- ggplot(data = small_data_subset) + theme_bw()
# second plot
plot2 &lt;- plot1 + 
  geom_point(aes(x = timestamp_hour, y = avg_meter_reading, col=timestamp_month))
# plot both
grid.arrange(plot1, plot2, ncol=2) # using gridExtra package</code></pre>
<p><img src="https://jakespiteri.co.uk/portfolio/computing/Report-6_files/figure-html/unnamed-chunk-13-1.png" width="1344" style="display: block; margin: auto;" /></p>
<p>When evaluating an object, R calls the generic <code>print</code> function. As our object has class <code>ggplot</code>, R calls the <code>print.ggplot</code> function. The main difference between <code>ggplot2</code> and <code>graphics</code> plotting methods is that <code>gplot2</code> separates the plot-building phase (defining a <code>ggplot</code> object and then adding layers) from the rendering phase (calling the <code>print</code> function).</p>
<p>A general template for creating a <code>ggplot</code> may look like:</p>
<pre class="r"><code>ggplot(data = &lt;data.frame&gt;) +
  &lt;geom_layer&gt;(mapping = aes(&lt;variables_map&gt;))</code></pre>
<p>In this template</p>
<ul>
<li><code>ggplot</code> creates a <code>ggplot</code> object, with a <code>data.frame</code> as its main argument.</li>
<li><code>+</code> is an overloaded operator. On the left hand side we have a <code>ggplot</code> object, and on the right hand side is a layer or function that modifies the plot.</li>
<li><code>&lt;geom_layer&gt;</code> is a graphical layer, such as <code>geom_point</code>. Each layer needs a mapping.</li>
</ul>
<p>We may be interested in the energy usage of new and modern buildings vs older buildings. To gain some insight we use <code>dplyr</code>‘s <code>mutate</code> to create a new factor variable denoting whether the building is ’Old’ or ‘Modern’. To do this we use two approaches: one in which buildings older than the median building age are considered old and those newer are considered to be modern. Another approach is to define buildings built after the year 2000 to be modern and before 2000 to be old.</p>
<pre class="r"><code>data_subset %&lt;&gt;%
  mutate(building_age_med = factor(as.logical(year_built &gt; median(year_built, na.rm=TRUE)),
                                   labels = c(&quot;Modern&quot;, &quot;Old&quot;)))

data_subset %&lt;&gt;%
  mutate(building_age_2 = factor((year_built &gt; 2000), 
                                 labels = c(&quot;Modern&quot;, &quot;Old&quot;)))

data_subset %&gt;%
  select(year_built, building_age_med, building_age_2) %&gt;%
  head()</code></pre>
<pre><code>##   year_built building_age_med building_age_2
## 1       1996              Old         Modern
## 2       1977              Old         Modern
## 3       2002              Old            Old
## 4       2008              Old            Old
## 5       1979              Old         Modern
## 6       1996              Old         Modern</code></pre>
<p>We then use <code>dplyr</code> and <code>ggplot2</code> to plot a graph.</p>
<pre class="r"><code># create data for building_age_med
data_subset_1 &lt;- data_subset %&gt;%
  filter(!is.na(building_age_med)) %&gt;%
  group_by(building_age_med, timestamp_hour) %&gt;%
  summarise(median_reading = median(meter_reading, na.rm=TRUE)) %&gt;%
  mutate(building_age_type = &quot;Median&quot;) %&gt;%
  dplyr::rename(building_age = building_age_med)

# create subset of data for building_age_2 i.e. &gt;2000 or &lt;2000
data_subset_2 &lt;- data_subset %&gt;%
  filter(!is.na(building_age_2)) %&gt;%
  group_by(building_age_2, timestamp_hour) %&gt;%
  summarise(median_reading = median(meter_reading, na.rm=TRUE)) %&gt;%
  mutate(building_age_type = &quot;&gt;2000&quot;) %&gt;%
  dplyr::rename(building_age = building_age_2)

data_subset_comb &lt;- bind_rows(data_subset_1, data_subset_2, id=NULL)
data_subset_comb$building_age_type &lt;- factor(data_subset_comb$building_age_type,
                                             labels=c(&quot;&gt;2000&quot;, &quot;Median&quot;))

data_subset_comb %&gt;%
  filter(!is.na(building_age)) %&gt;%
  ggplot(aes(x=as.numeric(timestamp_hour), y=median_reading, col=building_age)) +
  facet_wrap(vars(building_age_type)) +
  geom_line()</code></pre>
<p><img src="https://jakespiteri.co.uk/portfolio/computing/Report-6_files/figure-html/unnamed-chunk-16-1.png" width="576" style="display: block; margin: auto;" /></p>
<p>We clearly see on both facets that modern houses use less energy than old buildings In the left we see that energy usage increases dramatically around 1000 and decreases around 1400. This may imply that older buildings are less insulated than modern buildings, hence the need for heating the building throughout the day. We split the building age into decades below to further inspect the data.</p>
<pre class="r"><code>data_subset &lt;- data_subset %&gt;%
  mutate(decade_built = as.factor(floor((year_built)/10)*10))

data_subset %&gt;%
  filter(timestamp_month == &quot;Jan&quot;) %&gt;%
  select(decade_built, timestamp_hour, meter_reading) %&gt;%
  filter(!is.na(decade_built), decade_built %in% seq(1950,2010,10)) %&gt;%
  group_by(decade_built, timestamp_hour) %&gt;%
  summarise(median_reading = median(meter_reading, na.rm=TRUE)) %&gt;%
  ggplot(aes(x=as.numeric(timestamp_hour), y=median_reading, col=decade_built)) +
  geom_line()</code></pre>
<p><img src="https://jakespiteri.co.uk/portfolio/computing/Report-6_files/figure-html/unnamed-chunk-17-1.png" width="384" style="display: block; margin: auto;" /></p>
<p>This isn’t exactly what we expected, but it’s likely that there are higher-dimensional relationships within the data which we simply cannot capture with a 2D graph. There are many more factors which impact the average meter reading.</p>
<p>We may be interested in the median readings of different types of meter.</p>
<pre class="r"><code>data_subset$meter &lt;- factor(data_subset$meter, levels = 0:3)

data_subset %&gt;%
  group_by(meter) %&gt;%
  ggplot(aes(x = log(meter_reading + 1), fill = meter)) +
  geom_density(alpha=0.4, adjust=1.5) +
  scale_fill_discrete()</code></pre>
<p><img src="https://jakespiteri.co.uk/portfolio/computing/Report-6_files/figure-html/unnamed-chunk-18-1.png" width="384" style="display: block; margin: auto;" /></p>
<p>Let’s plot the median meter reading for each hour of the day.</p>
<pre class="r"><code>data_subset %&gt;%
  group_by(timestamp_hour) %&gt;%
  summarise(median_meter_reading = median(meter_reading)) %&gt;%
  ggplot(aes(x=timestamp_hour, y=median_meter_reading)) +
  geom_point() +
  geom_smooth()</code></pre>
<pre><code>## `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39;</code></pre>
<p><img src="https://jakespiteri.co.uk/portfolio/computing/Report-6_files/figure-html/unnamed-chunk-19-1.png" width="384" style="display: block; margin: auto;" /></p>
<p>We may be interested in a plot of median meter readings for each type of building in <code>primary_use</code>.</p>
<pre class="r"><code>data_subset %&gt;%
  group_by(timestamp_hour, primary_use) %&gt;%
  summarise(median_meter_reading = median(meter_reading)) %&gt;%
  ggplot(aes(x = as.numeric(timestamp_hour), y = median_meter_reading)) +
  geom_line(colour = &quot;skyblue&quot;) +
  facet_wrap(vars(primary_use), scales=&quot;free&quot;) +
  theme_minimal() + 
  labs(title = &quot;Median meter reading over the day&quot;,
       subtitle = &quot;For different building uses&quot;,
       x = &quot;Hour of the day&quot;, y = &quot;Average median reading&quot;)</code></pre>
<p><img src="https://jakespiteri.co.uk/portfolio/computing/Report-6_files/figure-html/unnamed-chunk-20-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>ggplot offers some nice tools for visualizing correlation matrices.</p>
<pre class="r"><code># get the correlation matrix
corrmat &lt;- data_subset %&gt;%
  select(-site_id) %&gt;%
  select_if(is.numeric) %&gt;%
  drop_na() %&gt;%
  {round(cor(.),2)}

# melt into long format ready for ggplot2
corrlong &lt;- melt(corrmat)

# plot with ggplot2
plot1 &lt;- corrlong %&gt;%
  ggplot(aes(x=X1, y=X2, fill = value)) +
  geom_tile() +
  labs(title = &quot;Matrix of variable correlations&quot;, x = &quot;&quot;, y = &quot;&quot;) +
  theme(axis.text.x = element_text(angle=90, hjust=1))

# plot only correlations with meter_reading
corrlong$X1 &lt;-  factor(corrlong$X1)
plot2 &lt;- corrlong %&gt;%
  filter(X2 == &quot;meter_reading&quot;) %&gt;%
  select(X1, value) %&gt;%
  as.data.frame() %&gt;%
  ggplot(aes(x = reorder(X1, value), y = value)) +
  geom_col() +
  coord_flip() + 
  labs(title = &quot;Correlation of factors with meter reading&quot;, 
       x=&quot;&quot;, y=&quot;Correlation&quot;)

grid.arrange(plot1, plot2, ncol=2)</code></pre>
<p><img src="https://jakespiteri.co.uk/portfolio/computing/Report-6_files/figure-html/unnamed-chunk-21-1.png" width="1344" style="display: block; margin: auto;" /></p>
<p>We are mostly interested in the factors which affect the meter reading. The above correlation matrix tells us that <code>meter_reading</code> is positively correlated with <code>square_feet</code> and <code>floor_count</code>. Let’s produce some plots to see the relationship.</p>
<pre class="r"><code>data_subset %&gt;%
  filter(square_feet &lt;= 4e+05, 
         timestamp_month == c(&quot;Jun&quot;)) %&gt;%
  group_by(building_id, meter) %&gt;%
  summarise(avg_meter_reading = median(meter_reading), 
            square_feet = mean(square_feet)) %&gt;%
  ggplot(aes(x=square_feet, y=avg_meter_reading)) +
  geom_point() +
  geom_smooth(method=&quot;glm&quot;) +
  labs(title = &quot;Average meter readings in June&quot;, 
       subtitle = &quot;GLM overlaid in blue&quot;, 
       y = &quot;Average meter reading&quot;, x = &quot;Square feet&quot;)</code></pre>
<p><img src="https://jakespiteri.co.uk/portfolio/computing/Report-6_files/figure-html/unnamed-chunk-22-1.png" width="384" style="display: block; margin: auto;" /></p>
<pre class="r"><code>data_subset %&gt;%
  filter(building_id != 685, building_id != 803, # remove outliers
         timestamp_month %in% c(&quot;Jun&quot;), !is.na(floor_count)) %&gt;%
  group_by(floor_count) %&gt;%
  summarise(avg_meter_reading = median(meter_reading)) %&gt;%
  ggplot(aes(x=floor_count, y=avg_meter_reading)) +
  geom_col() +
  labs(title = &quot;Average meter readings in June&quot;, 
       y = &quot;Average meter reading&quot;, x = &quot;Number of floors&quot;)</code></pre>
<p><img src="https://jakespiteri.co.uk/portfolio/computing/Report-6_files/figure-html/unnamed-chunk-23-1.png" width="384" style="display: block; margin: auto;" /></p>
<p>The graph seems to make sense. As the number of floors increases, the amount of energy needed to heat the building increases. There were some outliers which have to be removed such as the building with id <span class="math inline">\(685\)</span> which has 5 floors and approximately <span class="math inline">\(250,000\)</span> square feet! It uses much more energy than we would expect.</p>
</div>
</div>
</div>

            </div>
        </article>

        <hr />

        <div class="post-info">
  			</div>

        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2020</span>
            
                <span><a href="https://jakespiteri.co.uk">Jake Spiteri</a></span>
            
            <span><a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></span>
            <span> <a href="https://jakespiteri.co.uk/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
    </div>
</footer>
    



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/r.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>


    <script src="https://jakespiteri.co.uk/js/math-code.js"></script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  </body>
</html>
            
        </div>

        




<script type="text/javascript" src="https://jakespiteri.co.uk/bundle.min.2d5469329143160ae2456a69c3c76dc2d0a3b212b46afe291a51bd68650ed6f8697e001dab54f1c272c77ce08092a8c55e5bb4314e0ee334aab4b927ec896638.js" integrity="sha512-LVRpMpFDFgriRWppw8dtwtCjshK0av4pGlG9aGUO1vhpfgAdq1TxwnLHfOCAkqjFXlu0MU4O4zSqtLkn7IlmOA=="></script>



    </body>
</html>
